# Parser → EventTypes Mapping

**Last Updated:** 2025-12-22
**Version:** TribanFT v2.1+

---

## Overview

This document maps which parsers generate which `EventType` values. Understanding this relationship is critical for writing effective detectors, as **detectors can only match EventTypes that are actually generated by parsers**.

## Important Rules

1. **Layer Coherence:** EventTypes must match the log source layer
   - `PORT_SCAN` requires L3/L4 logs (firewall/IDS) — NOT generated by HTTP parsers
   - `SQL_INJECTION` requires L7 logs (application/web server)

2. **Detector Requirements:** A detector will **NEVER fire** if:
   - It filters by an EventType not generated by its configured parser
   - Example: `event_types: [PORT_SCAN]` + `parsers: [apache]` → **never fires**

3. **Multi-Event Generation:** A single log line can generate **multiple EventTypes**
   - Example: `GET /api?id=1' OR 1=1` generates both `HTTP_REQUEST` and `SQL_INJECTION`

---

## Parser Capabilities Matrix

| Parser | EventTypes Generated | Layer | Status |
|--------|---------------------|-------|--------|
| **Apache/Nginx** | HTTP_REQUEST, FAILED_LOGIN, SQL_INJECTION, WORDPRESS_ATTACK, XSS_ATTACK, PATH_TRAVERSAL, COMMAND_INJECTION, FILE_UPLOAD_MALICIOUS | L7 (HTTP) | Active |
| **MSSQL** | PRELOGIN_INVALID, FAILED_LOGIN | L7 (Database) | Active |
| **Syslog** | FAILED_LOGIN, SSH_ATTACK, RDP_ATTACK | L7 (System) | Active |
| **NFTables** | PORT_SCAN, NETWORK_SCAN | L3/L4 (Firewall) | Active (NEW) |
| **IPTables** | PORT_SCAN, NETWORK_SCAN | L3/L4 (Firewall) | Active (NEW) |

---

## Apache/Nginx Parser (apache.py)

**Parses:** Combined log format (`access.log`, `access_log`)

### EventTypes Generated

| EventType | Trigger Condition | Pattern Source |
|-----------|------------------|----------------|
| `HTTP_REQUEST` | **Always** (every valid log line) | N/A |
| `SQL_INJECTION` | URI or line matches SQL injection patterns | `apache.yaml: sql_injection` |
| `WORDPRESS_ATTACK` | URI matches WordPress attack patterns | `apache.yaml: wordpress` |
| `FAILED_LOGIN` | Status 401/403 **AND** URI matches login page | `apache.yaml: login_pages` |
| `XSS_ATTACK` | URI or line matches XSS patterns | `apache.yaml: xss_attack` |
| `PATH_TRAVERSAL` | URI or line matches traversal patterns | `apache.yaml: path_traversal` |
| `COMMAND_INJECTION` | URI or line matches command injection | `apache.yaml: command_injection` |
| `FILE_UPLOAD_MALICIOUS` | URI or line matches malicious upload | `apache.yaml: file_upload` |

### Event Generation Logic

```python
# apache.py:159-293
for log_line in access_log:
    events = []

    # 1. Always generate HTTP_REQUEST
    events.append(HTTP_REQUEST)

    # 2. Check SQL injection patterns
    if matches_sql_pattern(uri or line):
        events.append(SQL_INJECTION)

    # 3. Check WordPress patterns
    if matches_wordpress_pattern(uri or line):
        events.append(WORDPRESS_ATTACK)

    # 4. Check failed login (status-dependent)
    if status in [401, 403] AND matches_login_page(uri):
        events.append(FAILED_LOGIN)

    # 5. Check XSS patterns (NEW in v2.1+)
    if matches_xss_pattern(uri or line):
        events.append(XSS_ATTACK)

    # 6. Check path traversal (NEW in v2.1+)
    if matches_traversal_pattern(uri or line):
        events.append(PATH_TRAVERSAL)

    # 7. Check command injection (NEW in v2.1+)
    if matches_command_pattern(uri or line):
        events.append(COMMAND_INJECTION)

    # 8. Check malicious upload (NEW in v2.1+)
    if matches_upload_pattern(uri or line):
        events.append(FILE_UPLOAD_MALICIOUS)

    return events
```

---

## MSSQL Parser (mssql.py)

**Parses:** MSSQL error logs, authentication logs

### EventTypes Generated

| EventType | Trigger Condition | Pattern Source |
|-----------|------------------|----------------|
| `PRELOGIN_INVALID` | Invalid prelogin packet detected | Hardcoded in parser |
| `FAILED_LOGIN` | Login failed message in log | `mssql.yaml: failed_login` |

---

## Syslog Parser (syslog.py)

**Parses:** System authentication logs (`/var/log/auth.log`, `/var/log/secure`)

### EventTypes Generated

| EventType | Trigger Condition | Pattern Source |
|-----------|------------------|----------------|
| `FAILED_LOGIN` | SSH/PAM authentication failures | `syslog.yaml: authentication` |
| `SSH_ATTACK` | SSH-specific attack patterns | `syslog.yaml: ssh_attacks` |
| `RDP_ATTACK` | RDP authentication failures | `syslog.yaml: rdp` |

---

## NFTables/IPTables Parser (nftables.py) [NEW]

**Parses:** Kernel firewall logs (`/var/log/kern.log`, `/var/log/messages`)

### EventTypes Generated

| EventType | Trigger Condition | Detection Method |
|-----------|------------------|------------------|
| `PORT_SCAN` | Source IP connects to 5+ different ports | Behavioral analysis (port count tracking) |
| `NETWORK_SCAN` | Source IP makes 10+ connection attempts | Behavioral analysis (frequency tracking) |

### Event Generation Logic

```python
# nftables.py:91-293
# First pass: Track connection attempts
for log_line in firewall_log:
    if "[nftables]" or "[iptables]" in line:
        connection = parse_connection(line)
        port_attempts[source_ip].add(dest_port)
        timestamps[source_ip].append(timestamp)

# Second pass: Generate events based on patterns
for source_ip, ports in port_attempts.items():
    # PORT_SCAN: 5+ different ports
    if len(ports) >= 5:
        events.append(PORT_SCAN)

    # NETWORK_SCAN: 10+ connection attempts
    elif len(timestamps[source_ip]) >= 10:
        events.append(NETWORK_SCAN)
```

**Key Differences from Other Parsers:**
- **Behavioral analysis** instead of regex patterns
- **Multi-line aggregation** (tracks across multiple log entries)
- **State tracking** (maintains IP → ports mapping)

---

## EventTypes NOT Currently Generated

These EventTypes exist in `models.py` but **no parser currently generates them**:

| EventType | Expected Source | Status |
|-----------|----------------|--------|
| `HTTP_ERROR_4XX` | Apache/Nginx parser (future enhancement) | **Planned** |
| `HTTP_ERROR_5XX` | Apache/Nginx parser (future enhancement) | **Planned** |
| `DRUPAL_ATTACK` | Apache/Nginx parser (needs patterns) | **Needs Patterns** |
| `JOOMLA_ATTACK` | Apache/Nginx parser (needs patterns) | **Needs Patterns** |
| `FTP_ATTACK` | FTP parser | **Needs Parser** |
| `SMTP_ATTACK` | Mail server parser | **Needs Parser** |
| `CROWDSEC_BLOCK` | CrowdSec integration | **Needs Integration** |
| `KNOWN_MALICIOUS_IP` | Threat feed integration | **Needs Integration** |

---

## Writing Effective Detectors

### CORRECT Examples

```yaml
# Example 1: XSS detection (apache parser generates XSS_ATTACK)
metadata:
  name: xss_detector
log_sources:
  parsers: [apache]
detection:
  event_types: [XSS_ATTACK, HTTP_REQUEST]  # ✓ Apache generates these
  threshold: 3
  patterns:
    - regex: '(?i)<script>'
```

```yaml
# Example 2: SSH bruteforce (syslog parser generates FAILED_LOGIN + SSH_ATTACK)
metadata:
  name: ssh_bruteforce
log_sources:
  parsers: [syslog]
detection:
  event_types: [FAILED_LOGIN, SSH_ATTACK]  # ✓ Syslog generates these
  threshold: 10
```

### INCORRECT Examples

```yaml
# Example 1: Port scan detection with HTTP parser (WILL NEVER FIRE!)
metadata:
  name: port_scan_detector
log_sources:
  parsers: [apache]  # ERROR: Apache doesn't generate PORT_SCAN
detection:
  event_types: [PORT_SCAN]  # ERROR: Layer mismatch (L3/L4 vs L7)
  patterns:
    - regex: '.*'  # ERROR: Will never match because event_type never created
```

```yaml
# Example 2: SQL injection with wrong parser
metadata:
  name: sql_injection_detector
log_sources:
  parsers: [syslog]  # ERROR: Syslog doesn't generate SQL_INJECTION
detection:
  event_types: [SQL_INJECTION]  # ERROR: Wrong parser
  patterns:
    - regex: 'union select'  # ERROR: Will never fire
```

---

## Automatic Validation [NEW]

**Since v2.1+**, TribanFT automatically validates detector configurations at load time using `DetectorValidator`.

### What Gets Validated

1. **Parser/EventType Coherence**
   - Checks if configured parsers can generate required EventTypes
   - **Prevents silent failures** (detector never firing)

2. **EventType Existence**
   - Validates EventType names against models.py enum
   - Catches typos and invalid event types

### Validation Examples

```python
# INVALID: Will be REJECTED at load time
metadata:
  name: bad_detector
log_sources:
  parsers: [apache]  # L7 parser
detection:
  event_types: [PORT_SCAN]  # L3/L4 event

# Error logged:
# "Detector 'bad_detector': Parser 'apache' cannot generate
#  event_types ['port_scan']. This detector will NEVER fire!"
# Result: Detector NOT loaded
```

```python
# VALID: Will load successfully
metadata:
  name: good_detector
log_sources:
  parsers: [nftables]  # L3/L4 parser
detection:
  event_types: [PORT_SCAN]  # L3/L4 event

# Result: Detector loaded ✓
```

### Validation Behavior

| Severity | Action | Log Level |
|----------|--------|-----------|
| **Critical Error** | Detector rejected, not loaded | ERROR |
| **Warning** | Detector loaded with warning | WARNING |
| **Info** | Informational message | INFO |

**Critical Errors (detector rejected):**
- Parser cannot generate ANY required EventTypes
- Unknown EventType name

**Warnings (detector loaded):**
- Parser cannot generate SOME event types (will match on others)
- No parsers configured (uses all parsers)
- Unknown parser name (might be custom parser)

### Validation API

```python
from bruteforce_detector.utils.detector_validator import DetectorValidator

validator = DetectorValidator()

# Validate single detector
try:
    validator.validate_detector(detector_config)
except DetectorValidationError as e:
    print(f"Invalid: {e}")

# Get parsers that can generate event type
parsers = DetectorValidator.get_parsers_for_event_type(EventType.XSS_ATTACK)
# Returns: ['apache', 'nginx']

# Get event types a parser can generate
capabilities = DetectorValidator.get_parser_capabilities('nftables')
# Returns: {EventType.PORT_SCAN, EventType.NETWORK_SCAN}

# Suggest appropriate parsers for detector
parsers = DetectorValidator.suggest_parser_for_detector(['XSS_ATTACK', 'SQL_INJECTION'])
# Returns: ['apache', 'nginx']
```

---

## Changes in v2.1 (2025-12-22)

### New Parsers Implemented

1. **NFTables/IPTables Parser** (nftables.py)
   - Generates: `PORT_SCAN`, `NETWORK_SCAN`
   - Layer: L3/L4 (Firewall logs)
   - Method: Behavioral analysis (port/frequency tracking)
   - Thresholds: 5+ ports = PORT_SCAN, 10+ attempts = NETWORK_SCAN

### New EventTypes Generated

**Apache/Nginx Parser:** Now generates 4 additional EventTypes:

1. **XSS_ATTACK** — Cross-site scripting attempts
   - Patterns: `<script>`, `javascript:`, event handlers, embedded content

2. **PATH_TRAVERSAL** — Directory traversal and LFI/RFI
   - Patterns: `../`, `/etc/passwd`, `php://filter`, URL-encoded traversal

3. **COMMAND_INJECTION** — OS command injection
   - Patterns: Shell metacharacters (`|`, `;`, `&&`), command substitution

4. **FILE_UPLOAD_MALICIOUS** — Executable file uploads
   - Patterns: `.php`, `.jsp`, double extensions, SVG with script

### New Feature: Automatic Validation

**Detector Validator** (`detector_validator.py`)
- Validates parser/EventType coherence at load time
- Prevents misconfigured detectors (e.g., PORT_SCAN + apache parser)
- Rejects invalid configurations with descriptive errors
- Integrated into RuleEngine automatically

**Benefits:**
- Catch configuration errors before deployment
- Prevent silent failures (detectors that never fire)
- Clear error messages guiding fixes
- API for programmatic validation

### Pattern Improvements

**SQL Injection:** Patterns refined with SQL context to reduce false positives
- Before: `(?i).*or 1=1.*` (too generic)
- After: `(?i)(?:where|and|or)\s+['\"]?\d+['\"]?\s*=\s*['\"]?\d+['\"]?(?:--|#|/\*)` (with SQL keywords + comment)

**WordPress:** Removed redundant status code checks from regex
- Before: `(?i).*/wp-admin/.*\s+(401|403).*`
- After: `(?i)/wp-admin/` (parser already filters by status)

---

## Debugging Tips

### Detector Not Firing?

1. **Verify parser generates the EventType:**
   ```bash
   tribanft --detect --verbose | grep "event_type="
   ```

2. **Check pattern matching:**
   ```python
   # Test pattern against sample log line
   import re
   pattern = re.compile(r'(?i)<script>')
   log = '192.168.1.1 - - [22/Dec/2025] "GET /?q=<script> HTTP/1.1" 200'
   print(pattern.search(log))  # Should match
   ```

3. **Validate detector configuration:**
   ```bash
   python3 -c "import yaml; print(yaml.safe_load(open('detectors/mydetector.yaml')))"
   ```

### Common Mistakes

- **Layer Mismatch:** Using L3/L4 EventTypes (PORT_SCAN) with L7 parsers (apache)
- **Wrong Parser:** Filtering by EventType the configured parser doesn't generate
- **Pattern Too Generic:** Matches legitimate traffic (high false positives)
- **Pattern Too Specific:** Never matches real attacks (false negatives)

---

## Future Enhancements

### Planned Parsers

1. **NFTables/IPTables Parser** → Generate `PORT_SCAN`, `NETWORK_SCAN`
2. **Suricata/Snort Parser** → Generate IDS-specific events
3. **FTP Parser** → Generate `FTP_ATTACK`
4. **SMTP Parser** → Generate `SMTP_ATTACK`

### Planned EventTypes

- `DNS_AMPLIFICATION` (for DNS reflection attacks)
- `BRUTE_FORCE_DETECTED` (meta-event from aggregation)
- `RATE_LIMIT_EXCEEDED` (for API abuse)

---

## References

- **Parser Source Code:** `bruteforce_detector/plugins/parsers/`
- **Pattern Definitions:** `bruteforce_detector/rules/parsers/`
- **Detector Rules:** `bruteforce_detector/rules/detectors/`
- **EventType Enum:** `bruteforce_detector/models.py:27-101`
